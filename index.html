<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vivarent Analysis Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --card-bg: #020617;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.12);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2937;
      --shadow-soft: 0 18px 35px rgba(0, 0, 0, 0.45);
      --radius-xl: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 24px;
    }

    .dashboard-shell {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
    }

    .title-block h1 {
      font-size: 26px;
      margin: 0 0 4px;
      letter-spacing: 0.03em;
    }

    .title-block p {
      margin: 0;
      color: var(--text-muted);
      font-size: 13px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.3);
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    /* Filters */

    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 14px 16px;
      border-radius: var(--radius-xl);
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.96),
        rgba(15, 23, 42, 0.85)
      );
      border: 1px solid rgba(148, 163, 184, 0.22);
      margin-bottom: 18px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.8);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 130px;
    }

    .filter-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--text-muted);
    }

    select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      color: var(--text-main);
      padding: 6px 12px;
      font-size: 13px;
      outline: none;
      min-width: 120px;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(249, 115, 22, 0.5);
    }

    /* KPI cards */

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px;
      margin-bottom: 18px;
    }

    @media (max-width: 1100px) {
      .kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 650px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }
    }

    .kpi-card {
      position: relative;
      padding: 12px 13px;
      border-radius: var(--radius-xl);
      background: radial-gradient(
            circle at top left,
            rgba(249, 115, 22, 0.04),
            transparent 55%
          ),
          radial-gradient(
            circle at bottom right,
            rgba(15, 23, 42, 0.85),
            #020617 75%
          );
      border: 1px solid rgba(55, 65, 81, 0.85);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .kpi-badge {
      position: absolute;
      top: 9px;
      right: 10px;
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-muted);
    }

    .kpi-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .kpi-main {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.03em;
      margin-bottom: 4px;
    }

    .kpi-subrow {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .kpi-prev {
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.85;
    }

    .kpi-delta {
      font-size: 11px;
      font-weight: 500;
    }

    .kpi-delta.positive {
      color: #4ade80;
    }

    .kpi-delta.negative {
      color: #f87171;
    }

    /* Charts layout */

    .charts-grid {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      padding: 14px 16px;
      border-radius: var(--radius-xl);
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: var(--shadow-soft);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 14px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .panel-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .chart {
      width: 100%;
      height: 320px;
    }
  </style>
</head>

<body>
  <div class="dashboard-shell">
    <div class="header">
      <div class="title-block">
        <h1>Vivarent Fleet & Bookings</h1>
        <p>Overview by year, month and vehicle group with period-over-period comparison.</p>
      </div>
      <div>
        <div class="badge">
          <span class="badge-dot"></span>
          Live view · JSON data (fleet_agg & bookings_agg)
        </div>
      </div>
    </div>

    <!-- FILTER BAR -->
    <div class="filters-bar">
      <div class="filter-group">
        <span class="filter-label">Year</span>
        <select id="yearFilter"></select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Month</span>
        <select id="monthFilter">
          <option value="All">All months</option>
          <option value="1">Jan</option>
          <option value="2">Feb</option>
          <option value="3">Mar</option>
          <option value="4">Apr</option>
          <option value="5">May</option>
          <option value="6">Jun</option>
          <option value="7">Jul</option>
          <option value="8">Aug</option>
          <option value="9">Sep</option>
          <option value="10">Oct</option>
          <option value="11">Nov</option>
          <option value="12">Dec</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Vehicle group</span>
        <select id="groupFilter">
          <option value="All">All groups</option>
        </select>
      </div>
    </div>

    <!-- KPI CARDS -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <span class="kpi-badge">Fleet</span>
        <div class="kpi-label">Total fleet</div>
        <div class="kpi-main" id="kpi-fleet-main">-</div>
        <div class="kpi-subrow">
          <div class="kpi-prev" id="kpi-fleet-prev">Prec.: n/a</div>
          <div class="kpi-delta" id="kpi-fleet-delta"></div>
        </div>
      </div>

      <div class="kpi-card">
        <span class="kpi-badge">Costs</span>
        <div class="kpi-label">Lease cost</div>
        <div class="kpi-main" id="kpi-lease-main">-</div>
        <div class="kpi-subrow">
          <div class="kpi-prev" id="kpi-lease-prev">Prec.: n/a</div>
          <div class="kpi-delta" id="kpi-lease-delta"></div>
        </div>
      </div>

      <div class="kpi-card">
        <span class="kpi-badge">Costs</span>
        <div class="kpi-label">Insurance cost</div>
        <div class="kpi-main" id="kpi-ins-main">-</div>
        <div class="kpi-subrow">
          <div class="kpi-prev" id="kpi-ins-prev">Prec.: n/a</div>
          <div class="kpi-delta" id="kpi-ins-delta"></div>
        </div>
      </div>

      <div class="kpi-card">
        <span class="kpi-badge">Bookings</span>
        <div class="kpi-label">Revenue</div>
        <div class="kpi-main" id="kpi-rev-main">-</div>
        <div class="kpi-subrow">
          <div class="kpi-prev" id="kpi-rev-prev">Prec.: n/a</div>
          <div class="kpi-delta" id="kpi-rev-delta"></div>
        </div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="charts-grid">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Fleet count over time</div>
          <div class="panel-subtitle" id="fleetSubtitle"></div>
        </div>
        <div id="fleetChart" class="chart"></div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Bookings revenue</div>
          <div class="panel-subtitle" id="bookingsSubtitle"></div>
        </div>
        <div id="bookingsChart" class="chart"></div>
      </div>
    </div>
  </div>

  <script>
    let fleetData = [];
    let bookingsData = [];

    function formatNumber(val, decimals = 0) {
      if (val == null || isNaN(val)) return "-";
      return Number(val).toLocaleString("it-IT", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function monthLabel(m) {
      const labels = ["", "Gen", "Feb", "Mar", "Apr", "Mag", "Giu", "Lug", "Ago", "Set", "Ott", "Nov", "Dic"];
      return labels[m] || "";
    }

    function getPrevPeriod(year, month) {
      // month = "All" or numeric string
      if (month && month !== "All") {
        const m = parseInt(month, 10);
        if (m === 1) {
          return { year: year - 1, month: 12, label: monthLabel(12) + " " + (year - 1) };
        } else {
          return { year: year, month: m - 1, label: monthLabel(m - 1) + " " + year };
        }
      } else {
        return { year: year - 1, month: null, label: String(year - 1) };
      }
    }

    function filterDataset(data, year, month, group) {
      return data.filter(d => {
        const y = Number(d.year ?? d.Year);
        const m = Number(d.month ?? d.Month);
        const g = (d.group ?? d.Group ?? "").toString();

        if (!isNaN(year) && y !== year) return false;
        if (month && month !== "All" && m !== Number(month)) return false;
        if (group && group !== "All" && g !== group) return false;
        return true;
      });
    }

    function computeKPIs(fleetSlice, bookingsSlice) {
      const kpis = {
        fleet: 0,
        lease: 0,
        insurance: 0,
        revenue: 0
      };

      fleetSlice.forEach(d => {
        const fleetVal = Number(d.totalFleet ?? d.total_fleet ?? d.Fleet ?? d.total_vehicles ?? 0);
        const lease = Number(d.leaseCost ?? d.lease_cost ?? d.CanoneImponibile ?? 0);
        const ins = Number(d.insuranceCost ?? d.insurance_cost ?? d.CanoneAssicurativo ?? 0);
        kpis.fleet += fleetVal;
        kpis.lease += lease;
        kpis.insurance += ins;
      });

      bookingsSlice.forEach(d => {
        const rev = Number(d.totalRevenue ?? d.revenue ?? d.Revenue ?? 0);
        kpis.revenue += rev;
      });

      return kpis;
    }

    function updateKpiCard(mainId, prevId, deltaId, currentVal, prevVal, isCurrency = false) {
      const mainEl = document.getElementById(mainId);
      const prevEl = document.getElementById(prevId);
      const deltaEl = document.getElementById(deltaId);

      mainEl.textContent = isCurrency
        ? "€ " + formatNumber(currentVal, 0)
        : formatNumber(currentVal, 0);

      if (prevVal == null) {
        prevEl.textContent = "Prec.: n/a";
        deltaEl.textContent = "";
        deltaEl.className = "kpi-delta";
        return;
      }

      prevEl.textContent = (isCurrency ? "Prec.: € " : "Prec.: ") + formatNumber(prevVal, 0);

      if (!prevVal || prevVal === 0) {
        deltaEl.textContent = "";
        deltaEl.className = "kpi-delta";
        return;
      }

      const diffPct = ((currentVal - prevVal) / Math.abs(prevVal)) * 100;
      const sign = diffPct > 0 ? "+" : "";
      const pctTxt = sign + diffPct.toFixed(1) + "%";

      deltaEl.textContent = pctTxt;
      deltaEl.className = "kpi-delta " + (diffPct >= 0 ? "positive" : "negative");
    }

    function getCurrentFilters() {
      const year = Number(document.getElementById("yearFilter").value);
      const month = document.getElementById("monthFilter").value;
      const group = document.getElementById("groupFilter").value;
      return { year, month, group };
    }

    function updateDashboard() {
      if (!fleetData.length && !bookingsData.length) return;

      const { year, month, group } = getCurrentFilters();

      // CURRENT PERIOD
      const fleetCurrent = filterDataset(fleetData, year, month, group);
      const bookingsCurrent = filterDataset(bookingsData, year, month, group);
      const currentKpis = computeKPIs(fleetCurrent, bookingsCurrent);

      // PREVIOUS PERIOD (mese precedente o anno precedente)
      const prevPeriod = getPrevPeriod(year, month);
      let fleetPrev = [];
      let bookingsPrev = [];

      if (prevPeriod.year) {
        fleetPrev = filterDataset(fleetData, prevPeriod.year, prevPeriod.month ?? (month === "All" ? "All" : null), group);
        bookingsPrev = filterDataset(bookingsData, prevPeriod.year, prevPeriod.month ?? (month === "All" ? "All" : null), group);
      }

      const prevKpis = computeKPIs(fleetPrev, bookingsPrev);

      // KPI CARDS
      updateKpiCard("kpi-fleet-main", "kpi-fleet-prev", "kpi-fleet-delta", currentKpis.fleet,
        fleetPrev.length ? prevKpis.fleet : null, false);

      updateKpiCard("kpi-lease-main", "kpi-lease-prev", "kpi-lease-delta", currentKpis.lease,
        fleetPrev.length ? prevKpis.lease : null, true);

      updateKpiCard("kpi-ins-main", "kpi-ins-prev", "kpi-ins-delta", currentKpis.insurance,
        fleetPrev.length ? prevKpis.insurance : null, true);

      updateKpiCard("kpi-rev-main", "kpi-rev-prev", "kpi-rev-delta", currentKpis.revenue,
        bookingsPrev.length ? prevKpis.revenue : null, true);

      // SUBTITLES
      const subtitle = month && month !== "All"
        ? `${monthLabel(Number(month))} ${year}`
        : `Year ${year}`;

      const prevLabel = prevPeriod.label ? ` vs ${prevPeriod.label}` : "";
      document.getElementById("fleetSubtitle").textContent = `Period: ${subtitle}${prevLabel}`;
      document.getElementById("bookingsSubtitle").textContent = `Period: ${subtitle}${prevLabel}`;

      // CHARTS (semplici, per dare contesto)
      renderCharts(year, group);
    }

    function renderCharts(year, group) {
      const fleetYearSlice = filterDataset(fleetData, year, "All", group);
      const bookingsYearSlice = filterDataset(bookingsData, year, "All", group);

      const months = [...new Set(fleetYearSlice.map(d => Number(d.month ?? d.Month)))]
        .filter(m => !isNaN(m))
        .sort((a, b) => a - b);

      const fleetCounts = months.map(m => {
        const slice = fleetYearSlice.filter(d => Number(d.month ?? d.Month) === m);
        return slice.reduce((acc, d) => acc + Number(d.totalFleet ?? d.total_fleet ?? d.Fleet ?? d.total_vehicles ?? 0), 0);
      });

      const revMonths = [...new Set(bookingsYearSlice.map(d => Number(d.month ?? d.Month)))]
        .filter(m => !isNaN(m))
        .sort((a, b) => a - b);

      const revValues = revMonths.map(m => {
        const slice = bookingsYearSlice.filter(d => Number(d.month ?? d.Month) === m);
        return slice.reduce((acc, d) => acc + Number(d.totalRevenue ?? d.revenue ?? d.Revenue ?? 0), 0);
      });

      Plotly.newPlot("fleetChart", [{
        x: months.map(monthLabel),
        y: fleetCounts,
        type: "bar",
        hovertemplate: "Mese: %{x}<br>Fleet: %{y}<extra></extra>"
      }], {
        margin: { t: 10, r: 0, b: 40, l: 48 },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        xaxis: {
          tickfont: { color: "#9ca3af" }
        },
        yaxis: {
          tickfont: { color: "#9ca3af" }
        },
        showlegend: false
      }, { displayModeBar: false });

      Plotly.newPlot("bookingsChart", [{
        x: revMonths.map(monthLabel),
        y: revValues,
        type: "scatter",
        mode: "lines+markers",
        hovertemplate: "Mese: %{x}<br>Revenue: € %{y:,.0f}<extra></extra>"
      }], {
        margin: { t: 10, r: 0, b: 40, l: 48 },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        xaxis: {
          tickfont: { color: "#9ca3af" }
        },
        yaxis: {
          tickfont: { color: "#9ca3af" }
        },
        showlegend: false
      }, { displayModeBar: false });
    }

    function initFilters() {
      const yearSelect = document.getElementById("yearFilter");
      const groupSelect = document.getElementById("groupFilter");

      const years = new Set();
      const groups = new Set();

      fleetData.forEach(d => {
        const y = Number(d.year ?? d.Year);
        if (!isNaN(y)) years.add(y);
        const g = (d.group ?? d.Group ?? "").toString();
        if (g) groups.add(g);
      });

      bookingsData.forEach(d => {
        const y = Number(d.year ?? d.Year);
        if (!isNaN(y)) years.add(y);
        const g = (d.group ?? d.Group ?? "").toString();
        if (g) groups.add(g);
      });

      const yearsSorted = Array.from(years).sort((a, b) => a - b);
      yearSelect.innerHTML = "";
      yearsSorted.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      });

      groupSelect.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "All";
      allOpt.textContent = "All groups";
      groupSelect.appendChild(allOpt);

      Array.from(groups).sort().forEach(g => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        groupSelect.appendChild(opt);
      });

      // default: ultimo anno disponibile
      if (yearsSorted.length) {
        yearSelect.value = yearsSorted[yearsSorted.length - 1];
      }

      yearSelect.addEventListener("change", updateDashboard);
      document.getElementById("monthFilter").addEventListener("change", updateDashboard);
      groupSelect.addEventListener("change", updateDashboard);
    }

    async function loadData() {
      try {
        const [fleetRes, bookingsRes] = await Promise.all([
          fetch("fleet_agg.json"),
          fetch("bookings_agg.json")
        ]);

        fleetData = await fleetRes.json();
        bookingsData = await bookingsRes.json();

        initFilters();
        updateDashboard();
      } catch (err) {
        console.error("Error loading data", err);
      }
    }

    loadData();
  </script>
</body>
</html>
